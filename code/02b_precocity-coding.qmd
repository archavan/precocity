---
title: Coding precocity or altriciality status
author: Arun Chavan
format: 
  html:
    theme: cosmo
    self-contained: true
toc: true
editor: source
fontsize: 0.95em
editor_options: 
  chunk_output_type: inline
---

Started: 2023-11-22  
Last edited: `r format(Sys.time())`

# Background

Here we categorize species into precocial and altricial based on life history variables.

# Setup
```{r, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(dpi = 300, collapse = TRUE, comment = "#>", error = TRUE)

library(tidyverse)
library(here)
library(plotly)
library(ggrepel)
```

# Data

```{r}
#| message: false
#| warning: false

# pruned to species in the upham 2019 tree
pt <- read_csv(here("data/02_pruned/pantheria_upham2019.csv"))
mv <- read_csv(here("data/02_pruned/myhrvold_upham2019.csv"))
kd <- read_csv(here("data/02_pruned/mp-kd_upham2019.csv"))
```

# Compare PanTHERIA and Myhrvold datasets

```{r}
ptmv <- full_join(pt, 
                  mv, 
                  by = c("infraclass", "order", "family", "binomial"), 
                  suffix = c("_pt", "_mv"))
```

## The two datasets are largely concordant

Based on the adult body mass and gestation length comparison, the two datasets are largely concordant, with a small number of exceptions where the data for those species between the datasets is wildly different. Looking each of these species up individually, it seems like in some cases the PanTHERIA dataset has more reasonable values that agree with other sources while in other cases it's the Myhrvold dataset — there is no clearly worse dataset as a whole.

```{r}
#| fig-width: 5
#| fig-height: 5

body_mass_comparison <- ggplot(ptmv, 
                               aes(adult_body_mass_g_pt, 
                                   adult_body_mass_g_mv,
                                   label = binomial)) +
  geom_point(alpha = 0.75) +
  scale_x_log10() +
  scale_y_log10() +
  coord_equal() +
  theme_bw()

ggplotly(body_mass_comparison)
```

```{r}
#| fig-width: 5
#| fig-height: 5

gestation_comparison <- ggplot(ptmv, 
                               aes(gestation_len_d_pt, 
                                   gestation_len_d_mv,
                                   label = binomial)) +
  geom_point(alpha = 0.75) +
  scale_x_log10() +
  scale_y_log10() +
  coord_equal() +
  theme_bw()

ggplotly(gestation_comparison)
```

## Number of species with necessary information

For four of the variables of interest that are shared between the two datasets, Myhrvold dataset clearly has many more species with non-NA data. 

```{r}
pt %>% 
  filter(!is.na(adult_body_mass_g), 
         !is.na(gestation_len_d),
         !is.na(litter_size),
         !is.na(neonate_body_mass_g))

mv %>% 
  filter(!is.na(adult_body_mass_g), 
         !is.na(gestation_len_d),
         !is.na(litter_size),
         !is.na(neonate_body_mass_g))
```

## We will use PanTHERIA because it has "age at eye opening"

However, the PanTHERIA dataset has the variable of age of eye opening, which is crucial for coding precocity, but it's missing from the Myhrvold dataset. 

Therefore, for now, I will stick to using the PanTHERIA dataset, which is also the more popular one of the two. We still have more than 300 species for which we have non-NA data for all necessary variables. 

### Fill in missing data for monotremes

At this point, we have two monotreme species in the data, but PanTHERIA doesn't have age at eye opening for either of the two species. We will lose both of these data points if we use species with non-NA values for age at eye opening. Therefore, we will add these values from the literature. 

- Platypus (_Ornithorhynchus anatinus_)
  - ~ 93 days at eye opening (Thomas et al, 2020, doi:10.1071/am19019) after egg laying - 12 days of incubation, therefore 81 days after hatching. 
- Short-beaked echidna (_Tachyglossus aculeatus_)
  - eyes closed and hairless until 45 days, therefore lower bound of 45 days (Rismiller and Seymour, 1991, http://www.jstor.org/stable/24936795)
	- eyes are open at 70 days, therefore upper bound of 70 days (https://csiropedia.csiro.au/echidna-spiny-ant-eater-1969/)
	
For platypus, PanTHERIA also doesn't have neonate body mass. But Ferner et al (2017, https://doi.org/10.1111/joa.12689) have the neonate body mass information as 0.3-0.4 g. We will use the average 0.35 g. 


```{r}
pt <- pt %>% 
  mutate(age_at_eye_opening_d = case_when(
    binomial == "Ornithorhynchus_anatinus" ~ 81,
    binomial == "Tachyglossus_aculeatus" ~ 70,
    .default = age_at_eye_opening_d
  )) %>% 
  mutate(neonate_body_mass_g = case_when(
    binomial == "Ornithorhynchus_anatinus" ~ 0.35,
    .default = neonate_body_mass_g
  )) %>% 
  mutate(notes = case_when(
    binomial == "Ornithorhynchus_anatinus" ~ "age_at_eye_opening_d from https://doi.org/10.1071/am19019, neonate_body_mass_g from https://doi.org/10.1111/joa.12689",
    binomial == "Tachyglossus_aculeatus" ~ "age_at_eye_opening_d from https://csiropedia.csiro.au/echidna-spiny-ant-eater-1969/",
    .default = NA_character_
  )) 
```

### Filter PanTHERIA data

```{r}
pt_non_na <-  pt %>% 
  filter(!is.na(adult_body_mass_g), 
         !is.na(gestation_len_d),
         !is.na(litter_size),
         !is.na(neonate_body_mass_g),
         !is.na(age_at_eye_opening_d))

pt_non_na

count(pt_non_na, infraclass)
```

# Precocial/altricial coding

One option is to follow the coding scheme of [Martin and MacLarnon (1985)](https://doi.org/10.1038/313220a0) for eutherian mammals:

- Clearly precocial: 
  - litter size less than 1.5 and
  - eyes open at birth
- Clearly altricial: 
  - litter size is 3 or more and 
  - eyes do not open until at least 5 days after birth
- Intermediate: 
  - litter size between 1.5 and 3 and 
  - eyes open between 0 and 5 days of age
  
I will however use a modified version of this approach:

- follow the same logic for clearly altricial, clearly precocial, and clearly intermediate as Martin and MacLarnon. (the diagonals in the table below)
- For the species where age at eye opening is more than 5 days, code them as altricial regardless of the litter size. We can do this because this is a direct measure of developmental state at birth, unlike the litter size, which is a proxy. 
- Everything else, to be coded manually. Look up the information for these species and code them as altricial or precocial based on the literature.
  
## Discretize litter size and age and eye opening.

First, we discretize litter size and age at eye opening following Martin and MacLarnon. 

```{r}
pt_non_na <- pt_non_na %>% 
    mutate(litter_size_discrete = case_when(
      litter_size < 1.5 ~ "low", # <1.5
      litter_size >= 1.5 & litter_size < 3 ~ "medium", # [1.5-3)
      litter_size >= 3 ~ "high" # ≥3
    )) %>% 
    mutate(age_at_eye_opening_discrete = case_when(
      age_at_eye_opening_d == 0 ~ "low", # 0
      age_at_eye_opening_d > 0 & age_at_eye_opening_d < 5 ~ "medium", # (0-5)
      age_at_eye_opening_d >= 5 ~ "high" # ≥5
    )) %>% 
  mutate(
    litter_size_discrete = factor(litter_size_discrete, 
                                  levels = c("low", "medium", "high")),
    age_at_eye_opening_discrete = factor(age_at_eye_opening_discrete,
                                         levels = c("low", "medium", "high"))
  )
```
  
The distribution of litter size coloured by discretized age at eye opening looks like this:

```{r}
ggplot(pt_non_na, aes(litter_size, fill = age_at_eye_opening_discrete)) +
  geom_histogram(position = position_dodge(preserve = "single"), 
                 alpha = 0.7, 
                 color = "white", 
                 bins = 25) +
  facet_grid(rows = vars(infraclass),
             scales = "free_y") +
  theme_bw()
```

Table of discretized litter size and age at eye opening:

```{r}
table(pt_non_na$litter_size_discrete, 
      pt_non_na$age_at_eye_opening_discrete, 
      dnn = c("litter_size_discrete", 
              "age_at_eye_opening_discrete")) 
```

## Coding based on the discretized variables: algorithmic coding

```{r}
pt_coded_algorithmic <- pt_non_na %>% 
  mutate(precocity = case_when(
    age_at_eye_opening_discrete == "high" ~ "altricial",
    age_at_eye_opening_discrete == "low" & litter_size_discrete == "low" ~ "precocial",
    age_at_eye_opening_discrete == "medium" & litter_size_discrete == "medium" ~ "intermediate",
    .default = NA_character_
  )) %>% 
  mutate(coding_method = ifelse(!is.na(precocity), "algorithmic", "manual"))
```

## Coding based on the discretized varibles: manual coding

There are 31 species that need to be coded manually. 

```{r}
fs::dir_create(here("data/traits/manual-coding"))
pt_coded_algorithmic %>% 
  filter(is.na(precocity)) %>% 
  write_csv(here("data/03_coded/manual-coding/to-code.csv"))
```


```{r}
#| message: false
#| warning: false

# read in the table with manual codings
manually_coded <- read_csv(here("data/03_coded/manual-coding/coded.csv"))

# if precocity has not been defined by algorithmic methods, use manually coded value
pt_coded <- pt_coded_algorithmic %>% 
  mutate(precocity = map2_chr(
    binomial, 
    precocity,
    function(x, y) {
      ifelse(is.na(y),
             manually_coded$precocity[manually_coded$binomial == x],
             y)
    }
  ))
```

## Biased coding

We also want to code the precocity variable in altricial-biased and precocial-biased manner, so that we can repeat ancestral state reconstruction with different ways of coding the variable. This way we can ensure that the estimated ancestral state is not an artefact of the biases in coding. For altricial-biased, we will code the intermediates as altricial, and for precocial-biased we will code the intermediates as precocial. 

```{r}
pt_coded <- pt_coded %>% 
  mutate(precocity_altricial_biased = ifelse(
    precocity == "intermediate",
    "altricial",
    precocity
  )) %>% 
  mutate(precocity_precocial_biased = ifelse(
    precocity == "intermediate",
    "precocial",
    precocity
  )) 
```


# Explore precocity-coded data

## Frequency of preocial and altricial species

```{r}
count(pt_coded, precocity)
```

```{r}
count(pt_coded, precocity_altricial_biased)
count(pt_coded, precocity_precocial_biased)
```

```{r}
table(pt_coded$litter_size_discrete, 
      pt_coded$age_at_eye_opening_discrete, 
      dnn = c("litter_size_discrete", 
              "age_at_eye_opening_discrete")) 
```


## Compare with previous coding

Compare my current coding of precocity with the coding I had done in the past when I was last working on this. That included some manual coding from one of Mihaela's students, KD, as well. 

For the species that are common in both datasets — the current and the old one — there are zero species for which the precocity coding is discordant.

```{r}
pt_coded %>% 
  left_join(select(kd, binomial, precocity_kd), by = "binomial") %>% 
  filter(!is.na(precocity_kd)) %>% 
  filter(precocity != precocity_kd)
```

## Manual vs algorithmic coding

```{r}
pt_coded %>% 
  count(precocity, coding_method)
```

```{r}
pt_coded %>% 
  mutate(text_label = ifelse(coding_method == "manual",
                             binomial,
                             NA_character_)) %>% 
  ggplot(aes(adult_body_mass_g, gestation_len_d, label = text_label)) +
  geom_point(aes(shape = coding_method, 
                 color = precocity), 
             size = 2) +
  geom_text_repel(size = 2.5) +
  scale_x_log10() +
  scale_y_log10() +
  theme_bw()
```

Everything looks good. 

The only thing that stands out to me right now are the two data points in the otherwide altricial cloud of points that are both precocial and manually coded. These are _Lepus europaeus_ and _Lepus americanus_. These are both hare species, and I confirmed that they are both in fact precocial species. 


# Write data

```{r}
pt_coded <- relocate(pt_coded, notes, .after = last_col())
write_csv(pt_coded, here("data/03_coded/pt_precocity-data_v1.csv"))
```

# Session Info
```{r session_info, eval=TRUE}
sessionInfo()
```

