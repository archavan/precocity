---
title: Coding precocity or altriciality status
author: Arun Chavan
format: 
  html:
    theme: cosmo
    self-contained: true
toc: true
editor: source
fontsize: 0.95em
editor_options: 
  chunk_output_type: inline
---

Started: 2023-11-22  
Last edited: `r format(Sys.time())`

# Background

Here we categorize species into precocial and altricial based on life history variables.

# Setup
```{r, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(dpi = 300, collapse = TRUE, comment = "#>")

library(tidyverse)
library(here)
library(ggrepel)
```

# Data

```{r}
#| message: false
#| warning: false

# pruned to species in the upham 2019 tree
pt <- read_csv(here("data/02_pruned/pantheria_upham2019.csv"))
```

# Fill in missing data for monotremes

```{r}
filter(pt, rank03 == "Prototheria")
```


At this point, we have two monotreme species in the data, but PanTHERIA doesn't have age at eye opening for either of the two species. We will lose both of these data points if we use species with non-NA values for age at eye opening. Therefore, we will add these values from the literature. 

- Platypus (_Ornithorhynchus anatinus_)
  - ~ 93 days at eye opening (Thomas et al, 2020, doi:10.1071/am19019) after egg laying - 12 days of incubation, therefore 81 days after hatching. 
- Short-beaked echidna (_Tachyglossus aculeatus_)
  - eyes closed and hairless until 45 days, therefore lower bound of 45 days (Rismiller and Seymour, 1991, http://www.jstor.org/stable/24936795)
	- eyes are open at 70 days, therefore upper bound of 70 days (https://csiropedia.csiro.au/echidna-spiny-ant-eater-1969/)
	
For platypus, PanTHERIA also doesn't have neonate body mass. But Ferner et al (2017, https://doi.org/10.1111/joa.12689) have the neonate body mass information as 0.3-0.4 g. We will use the average 0.35 g. 


```{r}
pt <- pt %>% 
  mutate(age_at_eye_opening_d = case_when(
    binomial == "Ornithorhynchus_anatinus" ~ 81,
    binomial == "Tachyglossus_aculeatus" ~ 70,
    .default = age_at_eye_opening_d
  )) %>% 
  mutate(neonate_body_mass_g = case_when(
    binomial == "Ornithorhynchus_anatinus" ~ 0.35,
    .default = neonate_body_mass_g
  ))
```

### Filter PanTHERIA data

```{r}
pt_non_na <-  pt %>% 
  filter(!is.na(adult_body_mass_g), 
         !is.na(gestation_len_d),
         !is.na(litter_size),
         !is.na(neonate_body_mass_g),
         !is.na(age_at_eye_opening_d))

pt_non_na

count(pt_non_na, rank03)
```

# Precocial/altricial coding

One option is to follow the coding scheme of [Martin and MacLarnon (1985)](https://doi.org/10.1038/313220a0) for eutherian mammals:

- Clearly precocial: 
  - litter size less than 1.5 and
  - eyes open at birth
- Clearly altricial: 
  - litter size is 3 or more and 
  - eyes do not open until at least 5 days after birth
- Intermediate: 
  - litter size between 1.5 and 3 and 
  - eyes open between 0 and 5 days of age
  
I will however use a modified version of this approach:

- follow the same logic for clearly altricial, clearly precocial, and clearly intermediate as Martin and MacLarnon. (the diagonals in the table below)
- For the species where age at eye opening is more than 5 days, code them as altricial regardless of the litter size. We can do this because this is a direct measure of developmental state at birth, unlike the litter size, which is a proxy. 
- Everything else, to be coded manually. Look up the information for these species and code them as altricial or precocial based on the literature.
  
## Discretize litter size and age and eye opening.

First, we discretize litter size and age at eye opening following Martin and MacLarnon. 

```{r}
pt_non_na <- pt_non_na %>% 
    mutate(litter_size_discrete = case_when(
      litter_size < 1.5 ~ "low", # <1.5
      litter_size >= 1.5 & litter_size < 3 ~ "medium", # [1.5-3)
      litter_size >= 3 ~ "high" # ≥3
    )) %>% 
    mutate(age_at_eye_opening_discrete = case_when(
      age_at_eye_opening_d == 0 ~ "low", # 0
      age_at_eye_opening_d > 0 & age_at_eye_opening_d < 5 ~ "medium", # (0-5)
      age_at_eye_opening_d >= 5 ~ "high" # ≥5
    )) %>% 
  mutate(
    litter_size_discrete = factor(litter_size_discrete, 
                                  levels = c("low", "medium", "high")),
    age_at_eye_opening_discrete = factor(age_at_eye_opening_discrete,
                                         levels = c("low", "medium", "high"))
  )
```
  
The distribution of litter size coloured by discretized age at eye opening looks like this:

```{r}
ggplot(pt_non_na, aes(litter_size, fill = age_at_eye_opening_discrete)) +
  geom_histogram(position = position_dodge(preserve = "single"), 
                 alpha = 0.7, 
                 color = "white", 
                 bins = 25) +
  facet_grid(rows = vars(rank03),
             scales = "free_y") +
  theme_bw()
```

Table of discretized litter size and age at eye opening:

```{r}
table(pt_non_na$litter_size_discrete, 
      pt_non_na$age_at_eye_opening_discrete, 
      dnn = c("litter_size_discrete", 
              "age_at_eye_opening_discrete")) 
```

## Coding based on the discretized variables: algorithmic coding

```{r}
pt_coded_algorithmic <- pt_non_na %>% 
  mutate(precocity = case_when(
    age_at_eye_opening_discrete == "high" ~ "altricial",
    age_at_eye_opening_discrete == "low" & litter_size_discrete == "low" ~ "precocial",
    age_at_eye_opening_discrete == "medium" & litter_size_discrete == "medium" ~ "intermediate",
    .default = NA_character_
  )) %>% 
  mutate(coding_method = ifelse(!is.na(precocity), "algorithmic", "manual"))
```

## Coding based on the discretized varibles: manual coding

There are 31 species that need to be coded manually. 

```{r}
fs::dir_create(here("data/traits/manual-coding"))
pt_coded_algorithmic %>% 
  filter(is.na(precocity)) %>% 
  write_csv(here("data/03_coded/manual-coding/to-code.csv"))
```


```{r}
#| message: false
#| warning: false

# read in the table with manual codings
manually_coded <- read_csv(here("data/03_coded/manual-coding/coded.csv"))

# if precocity has not been defined by algorithmic methods, use manually coded value
pt_coded <- pt_coded_algorithmic %>% 
  mutate(precocity = map2_chr(
    binomial, 
    precocity,
    function(x, y) {
      ifelse(is.na(y),
             manually_coded$precocity[which(manually_coded$binomial == x)],
             y)
    }
  ))
```

# Explore precocity-coded data

## Frequency of preocial and altricial species

```{r}
count(pt_coded, precocity)
```

```{r}
table(pt_coded$litter_size_discrete, 
      pt_coded$age_at_eye_opening_discrete, 
      dnn = c("litter_size_discrete", 
              "age_at_eye_opening_discrete")) 
```

## Manual vs algorithmic coding

```{r}
pt_coded %>% 
  count(precocity, coding_method)
```

```{r}
pt_coded %>% 
  mutate(text_label = ifelse(coding_method == "manual",
                             binomial,
                             NA_character_)) %>% 
  ggplot(aes(adult_body_mass_g, gestation_len_d, label = text_label)) +
  geom_point(aes(shape = coding_method, 
                 color = precocity), 
             size = 2) +
  geom_text_repel(size = 2.5) +
  scale_x_log10() +
  scale_y_log10() +
  theme_bw()
```

Everything looks good. 

The only thing that stands out to me right now are the two data points in the otherwide altricial cloud of points that are both precocial and manually coded. These are _Lepus europaeus_ and _Lepus americanus_. These are both hare species, and I confirmed that they are both in fact precocial species. 


# Write data

```{r}
write_csv(pt_coded, here("data/03_coded/precocity-data_v1.csv"))
```

# Session Info
```{r session_info, eval=TRUE}
sessionInfo()
```

